#!/bin/bash
#####################################################################
# Script Name  : archive-bank
# Description  : archives HomeBank backup files from the previous month
# Dependencies : date, find, mv, rm, touch, zip
# Arguments    : none
# Author       : Richard Romig, 31 January 2019
# Email        : rick.romig@gmail.com
# Comment      : Run on the last date of the month!
#####################################################################

# create archive filename based on previous month
hbarchive=$(date --date="40 days ago" +"%Y-%m")
hbarchive+="-backup.zip"

# set reference date to
# 1 minute after midnight on the 1st day of the current month
rd=$(date +"%Y%m")
rd+="010001"

# store the current directory from where script was launched
curdir=$PWD

# create the temporary reference file
touch -t $rd /tmp/homebank.tmp 2>/dev/null
if [ "$?" -ne "0" ]; then
	echo "Error: Could not create /tmp/homebank.tmp"
	exit 1
fi

# go to HomeBank directory from wherever you are if you're not already there
if [ "$curdir" != ~/Documents/HomeBank ]; then
	pushd ~/Documents/HomeBank/ > /dev/null
fi

# create the backup folder if it doesn't exist
if [ ! -d ./backup/ ]; then
	mkdir backup
fi

# create the archive folder if it doesn't exist
if [ ! -d ./archive/ ]; then
	mkdir archive
fi

echo "Archiving HomeBank backup files from the previous calendar month..."

# move backup files from the previous month to the backup folder
find ./ -maxdepth 1 -type f -iname "*.bak" -not -newer /tmp/homebank.tmp -exec mv '{}' backup/ \;

# create a zipped archive in the backup folder
cd backup/
zip $hbarchive *

# if successful move the archive and delete the bak files
if [ "$?" -eq "0" ]; then
	mv $hbarchive ../archive/
	rm *.bak
else
	echo "Error: HomeBank backup archive not created."
	exit 1
fi

cd ..

rm /tmp/homebank.tmp

echo "HomeBank backup files archived."

# go back to wherever you started
if [ "$curdir" != ~/Documents/HomeBank ]; then
	popd > /dev/null
fi

exit 0

